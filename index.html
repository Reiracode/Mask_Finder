<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="icon" href="./iconmonstr-blue1.png" type="image/png" />
    <title>Mask Finder</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/MarkerCluster.css"></link> 
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/MarkerCluster.Default.css"></link>
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC:300,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./main.css">
</head>
<body>
    <div id="loading"><div class="loader"></div></div>

    <div class="main">
        <div id="map">
            <button id="open_arrow">
                <i class="fas fa-angle-up"></i>
            </button>
        </div>
 <!-- <div id="list"   class="my-selector-c"></div> -->
        <div id="list">
            <div class="my-selector-c">
                <div class="list_selector">
                    <select class="county select-selected"></select>  
                    <select class="district select-selected"></select>
                </div>

                <div id="mask_sel">
                        <button class="mask_all" data-item="all">ALL</button>
                        <button class="mask_all" data-item="adult">Adult</button>
                        <button class="mask_all" data-item="child">Child</button>  
                
                </div>
                <p>星期<span id="buyday"></span>身分證末碼<span id="dayno"></span>可購買</p>
            </div>

            <div id="storelist"></div>
        </div>
    </div>


<!-- <script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script> -->
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tw-city-selector@2.1.0/dist/tw-city-selector.min.js"></script>
<!-- <script src="http://maximeh.github.io/leaflet.bouncemarker/bouncemarker.js"></script> -->
<script defer src="https://use.fontawesome.com/releases/v5.0.0/js/all.js"></script>
<script>
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`); 
    window.addEventListener('resize', () => {
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    });

    (async function(){
        new TwCitySelector({
            el: ".my-selector-c",
            elCounty: ".county", // 在 el 裡查找 dom
            elDistrict: ".district" 
        });

        const loading = document.getElementById("loading");
        const selectDist= document.querySelector('.district');
        const mask_sel_btn= document.querySelector('#mask_sel');
        const maskBtn= document.querySelector('.mask_all');
        const open_arrow = document.getElementById("open_arrow");
        const open_menu = document.getElementById("list");

        var setloading = false;
        var selCity,selZone;
        var markers = new L.markerClusterGroup();
        var markersRef = {};
        let infoDay = await getDatInfo();
        let [latitude, longitude] = await getPosition();
        let infoPOSI = await getLocationA();

        let infoData = await getMaskInfo();


        var greenIcon = new L.Icon({
            iconUrl:'./iconmonstr-red3.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [42, 41],
            iconAnchor: [21, 41],
            popupAnchor: [1, -34],
            shadowSize: [0, 0]
        });

        var redIcon = new L.Icon({
            iconUrl:'./iconmonstr-blue1.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [42, 41],
            iconAnchor: [21, 41],
            popupAnchor: [1, -34],
            shadowSize: [0, 0]
        });

        const map = L.map('map', {
            center: ss = ![latitude,longitude]? [latitude,longitude] :[25.040065, 121.523235],
            zoom: 16
        });  

        const userIcon = L.icon({
            iconUrl: './iconmonstr-yellow1.png',
            iconSize: [40, 41],
            iconAnchor: [16, 36],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        })

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        function onLocationFound(e) {
            var radius = e.accuracy / 2;
            console.log(e.latlng)
            console.log(e.accuracy)

            L.marker(e.latlng,{icon: userIcon}).addTo(map)
                .bindPopup(" 我在這 ").openPopup();
            L.circle(e.latlng, radius).addTo(map);
        }

        function onLocationError(e) {
            console.log(e.message);
        }
        
        map.on('locationfound', onLocationFound);
        map.on('locationerror', onLocationError);
        map.locate({setView: true, maxZoom: 16});

        function getLocationA() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPositionA);
            } else { 
                console.log("Geolocation is not supported by this browser.");
            }
        }

        function showPositionA(position) {
            console.log("Latitude: " + position.coords.latitude + 
        "Longitude: " + position.coords.longitude);
        }

        function getPosition(){
            return new Promise(resolve=>{
                !!(navigator.geolocation)
                    ? navigator.geolocation.getCurrentPosition(position => {     
                        resolve([position.coords.latitude, position.coords.longitude])
                        })
                    : alert("Geolocation is not supported by your browser")
            })
        }

        function getMaskInfo(){
            return new Promise(resolve=>{
                fetch('https://raw.githubusercontent.com/kiang/pharmacies/master/json/points.json')
                    .then(res=>res.json())
                    .then(json=>resolve(json.features))
                    .catch(err=>console.log(err))
                    .then(response => 
                        loading.style.display = "none"             
                    );
            })
        }

        function getStore(){ 
            console.log(this)
            console.log(markersRef)
            console.log([sideInfo.indexOf(this)])
        
            if(!markersRef[sideInfo.indexOf(this)].isPopupOpen()){
                let marker = markersRef[sideInfo.indexOf(this)]
                console.log(marker)
                map.setView([marker._latlng.lat, marker._latlng.lng], 18)
                markers.zoomToShowLayer(marker, function() {
                    marker.openPopup();
                });
            }
        }

        function getDatInfo() {
            const dayInfo = ['日', '一', '二', '三', '四', '五', '六']
            let day = new Date().getDay();

            let daydescript = day === 0  
                ? '全部<span>皆</span>' 
                : day % 2 === 0 
                    ? '0 2 4 6 8'
                    : '1 3 5 7 9'
                    // console.log(daydescript)

            document.getElementById('buyday').innerText = dayInfo[day]
            document.getElementById('dayno').innerHTML =  daydescript

        }


        open_arrow.addEventListener("click", function() {
                open_menu.classList.toggle("active");
                this.classList.toggle('active')
        })

        selectDist.addEventListener('change', (event) => {
            console.log(event.target.value);
            selZone = event.target.value;
            var ey= document.querySelector('.county');
            selCity =ey.value;
            getDatInfo() ;
            findMask();
        });

        mask_sel_btn.addEventListener('click', (e) =>{
            if(e.target.nodeName=='BUTTON'){
                const showTitle = document.querySelectorAll(".store_title");
                var a_item = e.target.dataset['item'];
                console.log(e.target.dataset['item']);
                //  sideInfo.forEach(child => container.removeChild(child))
                showTitle.forEach(item=>hideUser(item,a_item));
            }
        })


        function hideUser(user,userclass){
            //store_tile
            userclass =='all' 
                ? user.parentElement.classList.remove('d-none') 
                : (user.dataset[userclass] > 0 )? user.parentElement.classList.remove('d-none')
                                                : user.parentElement.classList.add('d-none');
        }
        
        // var markers = new L.MarkerClusterGroup().addTo(map);
        function getDistance(origin, destination) {
            console.log(origin,destination)
            lat1 = origin[0]
            lng1 = origin[1] 
            lat2 = destination[0]
            lng2 = destination[1]

            return 2 * 6378.137 * Math.asin(Math.sqrt(Math.pow(Math.sin(Math.PI * (lat1-lat2)/360), 2)+Math.cos(Math.PI * lat1/180) * Math.cos(Math.PI * lat2/180)*Math.pow(Math.sin(Math.PI*(lng1-lng2)/360), 2)))

        }

        function toRadian(degree) {
            return degree*Math.PI/180;
        }

        //************************************************
        function filterPharmacy () {
            let res = [];
            let filterStore = infoData;
            res = filterStore.filter((item)=>item.properties.address.indexOf(selZone)> -1);
            return res;
            console.log(res);
        }

        function findMask() {
            markers.clearLayers();
            var res=[];
            markersRef =[]
            var dataAll = filterPharmacy();
            console.log(dataAll)
            
            var focus = dataAll[0].geometry.coordinates;
            map.setView([focus[1], focus[0]], 16);
            const s_list = document.getElementById('storelist');
            s_list.innerHTML = '';


            dataAll.forEach(({properties, geometry: {coordinates},index})=>{
                mask = (!!properties.mask_adult)? greenIcon :redIcon

                var marker = L.marker(new L.LatLng(coordinates[1],coordinates[0]),{icon:mask});
                var getDis =  getDistance([latitude,longitude],[coordinates[1], coordinates[0]])
                // console.log(properties.name +" : "+getDis)

                marker.bindPopup(
                    `<h2>${properties.name}</h2>
                    <p><a href="tel:${properties.phone}">${properties.phone}</a></p>
                    <div class="mask_size">
                    <span data-size="adult">成人${properties.mask_adult}</span>
                    <span data-size="child">小孩${properties.mask_child}</span>
                    </div>
                `)              
                markersRef.push(marker);
                markers.addLayer(marker); 


                var el = document.createElement('div');
                el.setAttribute('class','store_detail');
                var ps = (properties.note.length <= 1)
                    ? " "
                    : `<p><i class="fas fa-tag"></i>${properties.note}</p>`
                
                el.innerHTML = `
                    <h2 class="store_title" data-child=${properties.mask_child} 
                    data-adult=${properties.mask_adult}>${properties.name}
                    </h2>
                    <p><i class="fas fa-briefcase"></i>${properties.address}</p>
                    <p><i class="fas fa-phone fa-flip-horizontal"></i><a href="tel:${properties.phone}">${properties.phone}</a></p>
                    ${ps}
                    <div class="mask_size">
                        <span data-size='adult'>成人${properties.mask_adult}</span>
                        <span data-size='child'>小孩${properties.mask_child}</span>
                    </div>                       
                    <span>最後更新:${properties.updated}</span>
                `;

                    s_list.appendChild(el);        
                    sideInfo = [...document.querySelectorAll('.store_detail')]           
                    sideInfo.forEach(dom => dom.addEventListener('click', getStore))
            })  

            map.addLayer(markers);
        }

    })()
</script>
    
</body>
</html>